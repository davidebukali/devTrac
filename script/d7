#!/usr/bin/env bash

set -e

base_url='http://devtracd7.mountbatten.net/api'

echo "# Authenticating..."
login_result=`curl -d 'username=tester2&password=Bl1ckberry' "$base_url/user/login.json"`

session_id=`echo $login_result | cut -d '"' -f4`
session_name=`echo $login_result | cut -d '"' -f8`
user_id=`echo $login_result | cut -d '"' -f14`

echo "user_id = $user_id"
echo "session_name = $session_name"
echo "session_id = $session_id"

cookie="$session_name=$session_id"

image_path="script/site_image.png"
image_data_file="${image_path}.data"

openssl enc -base64 -in $image_path | tr -d '\n' > "$image_data_file"

image_size=`cat ${image_path}.data | wc -c | tr -d ' \n'`

post_data="uid=$user_id&filesize=$image_size&filename=$image_path"

echo

echo "# Uploading image..."
upload_file_result=`curl -b "$cookie" -d "$post_data" --data-urlencode "file@${image_path}.data" "$base_url/file"`
fid=`echo $upload_file_result | cut -d ' ' -f3`
echo "fid = $fid"

rm -f "$image_data_file"

